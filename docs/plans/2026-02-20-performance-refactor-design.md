# Crypto Dashboard Performance-First Refactor Design

**Date:** 2026-02-20  
**Owner:** Codex + 项目维护者  
**Scope:** 全面重构并以性能为优先目标（接受维护窗口）

---

## 1. 目标与原则

### 1.1 目标

1. 在保持核心业务语义可用前提下，显著降低热点 API P95 延迟。
2. 降低关键调度任务总耗时与调度冲突概率。
3. 降低 SQLite 读写冲突与慢查询比例。
4. 改善 `live-monitor` 首屏与轮询响应体验。

### 1.2 原则

1. 性能优先于结构“完美性”，但保留分层边界。
2. 每阶段独立可验证、可回滚。
3. 先观测后优化：基线先行，避免盲目改动。
4. 热路径优先，冷路径后移。

---

## 2. 当前瓶颈摘要

1. `app/database.py`（超大模块）职责混杂，热点 SQL 与非热点 SQL 共存。
2. `app/scheduler.py`（超大模块）同时承担配置、调度、并发、业务调用。
3. `app/trade_processor.py`（超大模块）抓取、转换、计算与持久化耦合。
4. 热点接口聚合链路较长，部分路径存在重复查询与重复计算。
5. 前端监控页存在全量刷新与非必要渲染开销。

---

## 3. 目标架构

1. `app/core/`
   - `scheduler_config.py`: 调度配置解析
   - `job_runtime.py`: 并发预算、限流、互斥、退避
   - `metrics.py`: 统一性能埋点（API/任务/SQL）
2. `app/jobs/`
   - 仅任务实现，不负责调度注册与全局配置。
3. `app/repositories/`
   - `trade/snapshot/settings/sync/risk` 分域仓储。
   - `Database` 暂作兼容门面，逐步瘦身。
4. `app/services/`
   - 聚合逻辑与缓存策略统一收敛。
5. `app/api/`
   - 仅请求参数校验、鉴权、响应封装。

---

## 4. 分阶段实施

### Phase A: 可观测性与性能基线

1. 新增统一性能埋点（接口、任务、SQL）。
2. 建立基线报告：P50/P95、吞吐、慢查询分布、任务耗时。
3. 增加性能回归测试入口（至少 smoke 级别）。

### Phase B: 调度与并发重构

1. 将 `scheduler.py` 的配置/并发控制下沉到 `core`。
2. 统一线程池与 API 权重预算。
3. 任务分级执行：高频同步、榜单计算、风控复盘分层调度。

### Phase C: 数据层与查询优化

1. 按域拆分 `database.py` 到 repositories。
2. 热点查询补索引与批处理（基于 `EXPLAIN QUERY PLAN`）。
3. 快照读取优先，减少在线聚合。

### Phase D: API 与前端性能

1. 热点 API 加短 TTL 缓存与写后失效机制。
2. `live-monitor` 改为增量拉取、按需渲染。
3. 大表格分页/窗口化，降低 DOM 渲染压力。

---

## 5. 风险与缓解

1. **风险：优化引入行为偏差**  
   缓解：关键接口 contract tests + 回归快照测试。

2. **风险：并发提升触发外部 API 限流**  
   缓解：统一预算、退避、冷却窗口与熔断。

3. **风险：SQL 优化导致边界数据变化**  
   缓解：双路径对比（旧实现 vs 新实现）并灰度切换。

4. **风险：缓存导致短期陈旧**  
   缓解：短 TTL + 写后失效 + 明确数据时效提示。

---

## 6. 验收标准（Definition of Done）

1. 热点 API（`/api/open-positions`, `/api/leaderboard`）P95 显著下降（目标 >= 30%）。
2. 关键调度任务总耗时下降（目标 >= 25%）。
3. 慢查询（阈值 200ms）比例显著下降（目标 >= 40%）。
4. `live-monitor` 首屏和交互响应改善（目标 >= 30%）。
5. 全量测试通过，且新增性能回归基线测试通过。

