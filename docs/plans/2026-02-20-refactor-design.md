# Crypto Dashboard Refactor Design

**Date:** 2026-02-20  
**Owner:** Codex + 项目维护者  
**Scope:** 零行为变更前提下，分 2-3 期提升可维护性

---

## 1. 背景与目标

当前项目功能完整，但可维护性压力集中在三个超大模块：

1. `app/main.py` 仍承载大量业务聚合逻辑（路由与业务耦合）。
2. `app/scheduler.py` 同时承担配置、任务编排、业务规则、通知文案。
3. `app/database.py` 同时承担建表/迁移/查询/统计，职责过载。

本次重构目标：

1. **可维护性优先**：降低认知负担和改动冲突面。
2. **零行为变更**：API 路径、字段、页面行为、调度时刻保持一致。
3. **2-3 期渐进**：每期可验证、可回滚，不做大爆炸式改造。

---

## 2. 约束与非目标

### 2.1 硬约束

1. 不改现有 API 路径。
2. 不改现有响应 JSON 字段语义。
3. 不改现有模板页面交互行为。
4. 不改调度任务默认 cron 与业务规则语义。
5. 除非额外批准，不做数据库 schema 变更。

### 2.2 非目标

1. 本轮不引入新 UI 框架。
2. 本轮不切换数据库类型（继续 SQLite）。
3. 本轮不重写交易策略或风控逻辑。

---

## 3. 目标架构

采用“薄路由 + 服务编排 + 仓储访问 + 作业任务”分层：

1. `app/api/`：路由、请求参数校验、响应封装。
2. `app/services/`：跨数据源业务聚合与字段衍生。
3. `app/repositories/`：数据库读写（由 `Database` 渐进拆分）。
4. `app/jobs/`：定时任务单元（由 `scheduler.py` 渐进拆分）。
5. `app/core/`：通用依赖、配置、时间工具、安全依赖。
6. `app/domain/`：纯计算与模型（尽量无 I/O）。

过渡策略：**绞杀式迁移**（新旧实现并存，逐域切换，稳定后删除旧实现）。

---

## 4. 分期方案

## Phase 1: 结构骨架期（低风险）

目标：先让代码组织清晰，不触碰核心业务行为。

实施：

1. 建立 `app/api`, `app/services`, `app/repositories`, `app/core` 目录。
2. 将 `main.py` 路由按域迁入 `app/api/*`，函数逻辑先保持不变。
3. 统一依赖注入与工具到 `core`：
   - `get_db`
   - `require_admin_token`
   - 时间/时区工具（UTC+8）
4. `Database` 暂不拆 SQL，仅加仓储门面层供后续 phase 使用。

验收：

1. 所有页面和 API 正常。
2. 现有测试通过。
3. 无行为差异。

## Phase 2: 业务域迁移期（推荐优先迁榜单与持仓）

目标：把“重计算 + 衍生字段”从路由层迁到服务层。

实施：

1. 迁移 `leaderboard/rebound` 相关聚合到 `services/leaderboard_service.py`。
2. 迁移 `open-positions` 聚合到 `services/positions_service.py`。
3. 路由层仅保留 I/O（参数和返回），不写业务循环与计算。

验收：

1. 关键接口字段完全一致。
2. 通过快照或对比测试验证“同输入同输出”。

## Phase 3: 调度与数据层解耦期

目标：拆分超大文件职责，降低后续改动回归风险。

实施：

1. 将 `scheduler.py` 拆为：
   - 任务注册器（保留在 scheduler）
   - 任务实现（迁入 `jobs/*`）
2. 将 `database.py` 渐进拆分为分仓储：
   - `trade_repo`
   - `snapshot_repo`
   - `settings_repo`
   - `sync_repo`
3. SQL 语句先保持不变，优先做职责分离。

验收：

1. 定时任务执行行为一致（日志与数据落库一致）。
2. 手动同步与风控接口行为一致。
3. 无 schema 变更。

---

## 5. 测试策略

每期都执行下列测试基线：

1. **Contract tests**：锁定关键 API 字段与结构。
2. **Snapshot tests**：复杂 JSON（排行榜增强、复盘汇总）快照比对。
3. **Job behavior tests**：午间/夜间任务在固定输入下产出一致。
4. **Template smoke tests**：页面渲染与静态资源可访问。

补充要求：

1. 新迁移一个域，至少新增该域 1-2 个行为测试。
2. 无测试保护的模块不做大搬迁。

---

## 6. 回滚策略

1. 每个 Phase 独立提交组，不跨期混改。
2. 关键路由切换保留旧实现兜底一个迭代周期。
3. 出现回归时仅回滚当前 phase 的提交组。
4. 禁止“边改结构边改业务语义”。

---

## 7. 风险与缓解

1. **风险：迁移期新旧逻辑偏差**  
   缓解：同输入对比测试 + 灰度切换。

2. **风险：过度抽象导致阅读成本上升**  
   缓解：YAGNI，仅按域拆分，不提前建复杂抽象层。

3. **风险：测试环境不稳定**  
   缓解：先固定本地验证链路（pytest 可执行）再迁移。

---

## 8. Definition of Done

满足以下条件视为重构完成：

1. `main.py` 只保留应用装配与少量入口，不再承载核心业务循环。
2. `scheduler.py` 仅负责注册和生命周期，任务实现独立。
3. `database.py` 核心查询职责已按域拆分到 repository。
4. 核心 API 行为与字段保持一致。
5. 回归测试基线稳定可执行。

